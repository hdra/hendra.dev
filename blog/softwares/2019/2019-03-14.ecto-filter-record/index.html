<!doctype html><html><head><link href="https://fonts.googleapis.com/css?family=Gentium+Book+Basic|Merriweather:400,300" rel=stylesheet type=text/css><link rel=stylesheet href=https://hendra.dev/styles/style.min.adafe591d9bc2917608cd56205e2997041b7f1d2a684555879647388e2c838f2.css></head><body><div class=container><header class=blog-header><h1><a href=https://hendra.dev/>hendra.dev</a></h1><p>A work in progress</p><nav><ul class=nav><li><a href=/blog/>blogs</a></li><li><a href=/notes/>notes</a></li></ul></nav></header><div class=post><header><h1>Filtering Ecto Queries</h1><p class=date>Written on <time datetime=2019-05-11T20:40:00+0700>May 11, 2019</time></p></header><article><p>Say you have blogging app with a <code>Post</code> schema, and you want to be able to search for posts that are written by certain author, posts that where published after a certain date, or posts that contains a certain string.</p><p>That is pretty simple to do with Ecto. You can start with something like this:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-elixir data-lang=elixir><span style=color:#00a8c8>defmodule</span> <span style=color:#75af00>Blog</span> <span style=color:#00a8c8>do</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>get_posts</span><span style=color:#111>(</span><span style=color:#111>filters</span><span style=color:#111>)</span> <span style=color:#00a8c8>do</span>
    <span style=color:#75af00>Post</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#111>where</span><span style=color:#111>(</span><span style=color:#d88200>author_id</span><span style=color:#111>:</span> <span style=color:#111>filters</span><span style=color:#111>[</span><span style=color:#d88200>:author_id</span><span style=color:#111>])</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#111>where</span><span style=color:#111>([</span><span style=color:#111>p</span><span style=color:#111>],</span> <span style=color:#111>p</span> <span style=color:#f92672>&gt;</span> <span style=color:#111>filter</span><span style=color:#111>[</span><span style=color:#d88200>:publication_date</span><span style=color:#111>])</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#111>where</span><span style=color:#111>([</span><span style=color:#111>p</span><span style=color:#111>],</span> <span style=color:#111>like</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>.</span><span style=color:#111>title</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;%</span><span style=color:#d88200>#{</span><span style=color:#f92672>^</span><span style=color:#111>filters</span><span style=color:#111>[</span><span style=color:#d88200>:title</span><span style=color:#111>]</span><span style=color:#d88200>}</span><span style=color:#d88200>%&#34;</span><span style=color:#111>))</span>
  <span style=color:#00a8c8>end</span>
<span style=color:#00a8c8>end</span>
</code></pre></div><p>One obvious issue with this is that if you don&rsquo;t provide a value for a particular key, Ecto will pass a <code>nil</code> into the query, which is not what you want. You can easily work around this by pattern-matching for the value passed into the filter, and returning the query as is if it matches <code>nil</code>. The schema module seems like a pretty good place for this, which also gives the added benefit of abstracting away the column implementation detail for each of the filtering mechanism.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-elixir data-lang=elixir><span style=color:#00a8c8>defmodule</span> <span style=color:#75af00>Blog.Schema.Post</span> <span style=color:#00a8c8>do</span>
  <span style=color:#111>schema</span> <span style=color:#d88200>&#34;posts&#34;</span> <span style=color:#00a8c8>do</span>
    <span style=color:#75715e>#.....</span>
  <span style=color:#00a8c8>end</span>

  <span style=color:#00a8c8>def</span> <span style=color:#111>by_author</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>),</span> <span style=color:#d88200>do</span><span style=color:#111>:</span> <span style=color:#111>query</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>by_author</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>author_id</span><span style=color:#111>)</span> <span style=color:#00a8c8>do</span>
    <span style=color:#111>query</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#111>where</span><span style=color:#111>(</span><span style=color:#d88200>author_id</span><span style=color:#111>:</span> <span style=color:#111>author_id</span><span style=color:#111>)</span>
  <span style=color:#00a8c8>end</span>

  <span style=color:#00a8c8>def</span> <span style=color:#111>after_publication_date</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>),</span> <span style=color:#d88200>do</span><span style=color:#111>:</span> <span style=color:#111>query</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>after_publication_date</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>date</span><span style=color:#111>)</span> <span style=color:#00a8c8>do</span>
    <span style=color:#111>query</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#111>where</span><span style=color:#111>([</span><span style=color:#111>p</span><span style=color:#111>],</span> <span style=color:#111>p</span><span style=color:#f92672>.</span><span style=color:#111>publication_date</span> <span style=color:#f92672>&gt;</span> <span style=color:#f92672>^</span><span style=color:#111>date</span><span style=color:#111>)</span>
  <span style=color:#00a8c8>end</span>

  <span style=color:#00a8c8>def</span> <span style=color:#111>title_contains</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>),</span> <span style=color:#d88200>do</span><span style=color:#111>:</span> <span style=color:#111>query</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>title_contains</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>title</span><span style=color:#111>)</span> <span style=color:#00a8c8>do</span>
    <span style=color:#111>query</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#111>where</span><span style=color:#111>([</span><span style=color:#111>p</span><span style=color:#111>],</span> <span style=color:#111>like</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>.</span><span style=color:#111>title</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;%</span><span style=color:#d88200>#{</span><span style=color:#f92672>^</span><span style=color:#111>title</span><span style=color:#d88200>}</span><span style=color:#d88200>%&#34;</span><span style=color:#111>))</span>
  <span style=color:#00a8c8>end</span>
<span style=color:#00a8c8>end</span>
</code></pre></div><p>These functions can be consumed as such:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-elixir data-lang=elixir><span style=color:#00a8c8>defmodule</span> <span style=color:#75af00>Blog</span> <span style=color:#00a8c8>do</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>get_posts</span><span style=color:#111>(</span><span style=color:#111>filters</span><span style=color:#111>)</span> <span style=color:#00a8c8>do</span>
    <span style=color:#75af00>Post</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#75af00>Post</span><span style=color:#f92672>.</span><span style=color:#111>by_author</span><span style=color:#111>(</span><span style=color:#111>filter</span><span style=color:#111>[</span><span style=color:#d88200>:author_id</span><span style=color:#111>])</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#75af00>Post</span><span style=color:#f92672>.</span><span style=color:#111>after_publication_date</span><span style=color:#111>(</span><span style=color:#111>filter</span><span style=color:#111>[</span><span style=color:#d88200>:publication_date</span><span style=color:#111>])</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#75af00>Post</span><span style=color:#f92672>.</span><span style=color:#111>title_contains</span><span style=color:#111>(</span><span style=color:#111>filter</span><span style=color:#111>[</span><span style=color:#d88200>:title</span><span style=color:#111>])</span>
  <span style=color:#00a8c8>end</span>
<span style=color:#00a8c8>end</span>
</code></pre></div><p>So far so good, but all the match-clauses for the <code>nil</code> value is getting pretty repetitive. Plus, if you were to add a new filtering option, you&rsquo;d have to make the change on multiple places; once to add the filter function on the schema module, and also another one on the service module/ context module to call the new filter function.</p><p>There is another way to do this. Since in Elixir a map can be easily converted into a keyword list, and since keyword lists consists of 2-elements tuples, it is a good candidate for pattern matching.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-elixir data-lang=elixir><span style=color:#00a8c8>defmodule</span> <span style=color:#75af00>Blog.Schema.Post</span> <span style=color:#00a8c8>do</span>
  <span style=color:#111>schema</span> <span style=color:#d88200>&#34;posts&#34;</span> <span style=color:#00a8c8>do</span>
    <span style=color:#75715e>#.....</span>
  <span style=color:#00a8c8>end</span>

  <span style=color:#00a8c8>def</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>filters</span><span style=color:#111>)</span> <span style=color:#f92672>when</span> <span style=color:#111>is_map</span><span style=color:#111>(</span><span style=color:#111>filters</span><span style=color:#111>),</span> <span style=color:#d88200>do</span><span style=color:#111>:</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#75af00>Map</span><span style=color:#f92672>.</span><span style=color:#111>to_list</span><span style=color:#111>(</span><span style=color:#111>filters</span><span style=color:#111>))</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>[]),</span> <span style=color:#d88200>do</span><span style=color:#111>:</span> <span style=color:#111>query</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>[{</span><span style=color:#d88200>:author_id</span><span style=color:#111>,</span> <span style=color:#111>author_id</span><span style=color:#111>}</span> <span style=color:#f92672>|</span> <span style=color:#111>filters</span><span style=color:#111>])</span> <span style=color:#00a8c8>do</span>
    <span style=color:#111>where</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#d88200>author_id</span><span style=color:#111>:</span> <span style=color:#111>author_id</span><span style=color:#111>)</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>filters</span><span style=color:#111>)</span>
  <span style=color:#00a8c8>end</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>[{</span><span style=color:#d88200>:publication_date</span><span style=color:#111>,</span> <span style=color:#111>date</span><span style=color:#111>}</span> <span style=color:#f92672>|</span> <span style=color:#111>filters</span><span style=color:#111>])</span> <span style=color:#00a8c8>do</span>
    <span style=color:#111>where</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>[</span><span style=color:#111>p</span><span style=color:#111>],</span> <span style=color:#111>p</span><span style=color:#f92672>.</span><span style=color:#111>publication_date</span> <span style=color:#f92672>&gt;</span> <span style=color:#f92672>^</span><span style=color:#111>date</span><span style=color:#111>)</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>filters</span><span style=color:#111>)</span>
  <span style=color:#00a8c8>end</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>[{</span><span style=color:#d88200>:title</span><span style=color:#111>,</span> <span style=color:#111>title</span><span style=color:#111>}</span> <span style=color:#f92672>|</span> <span style=color:#111>filters</span><span style=color:#111>])</span> <span style=color:#00a8c8>do</span>
    <span style=color:#111>where</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>[</span><span style=color:#111>p</span><span style=color:#111>],</span> <span style=color:#111>like</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>.</span><span style=color:#111>title</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;%</span><span style=color:#d88200>#{</span><span style=color:#f92672>^</span><span style=color:#111>title</span><span style=color:#d88200>}</span><span style=color:#d88200>%&#34;</span><span style=color:#111>))</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>filters</span><span style=color:#111>)</span>
  <span style=color:#00a8c8>end</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>[</span><span style=color:#111>_</span> <span style=color:#f92672>|</span> <span style=color:#111>filters</span><span style=color:#111>]),</span> <span style=color:#d88200>do</span><span style=color:#111>:</span> <span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>query</span><span style=color:#111>,</span> <span style=color:#111>filters</span><span style=color:#111>)</span>
<span style=color:#00a8c8>end</span>
</code></pre></div><p>It can be used with simply:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-elixir data-lang=elixir><span style=color:#00a8c8>defmodule</span> <span style=color:#75af00>Blog</span> <span style=color:#00a8c8>do</span>
  <span style=color:#00a8c8>def</span> <span style=color:#111>get_posts</span><span style=color:#111>(</span><span style=color:#111>filters</span><span style=color:#111>)</span> <span style=color:#00a8c8>do</span>
    <span style=color:#75af00>Post</span>
    <span style=color:#f92672>|&gt;</span> <span style=color:#75af00>Post</span><span style=color:#f92672>.</span><span style=color:#111>filter</span><span style=color:#111>(</span><span style=color:#111>filters</span><span style=color:#111>)</span>
  <span style=color:#00a8c8>end</span>
<span style=color:#00a8c8>end</span>
</code></pre></div><p>It accepts both map and keyword list as argument, as the function will pattern match for a map and convert it into a keyword list. That part can be omitted if you prefer to restrict the filter to a keyword list for some reason.</p><p>The <code>filter</code> function will go through all the keys within the filters that is passed as argument. It uses Elixir&rsquo;s pattern matching feature to extract the head and the tails of the filters list. If the head matches a key that it knows how to filter, it will apply the filter to the query and call the same function recursively with the remaining items in the tail. If it run into an unknown key, it will ignore the head and call the function again with the remaining tail and the unchanged query. And finally, when it has gone through all the items in the list, it will return the query.</p><p>As you can see, it is a pretty simple technique, there is no fancy math concept or complicated algorithms involved. It is implemented with the basic features of Elixir&rsquo;s pattern matching, function guard, recursive function call.</p><p>From what I&rsquo;ve seen, one of the more common road-bumps in learning Elixir coming from a OOP background is figuring out where some of these concepts come to use when they can use conditionals and loops that they are already familiar with to achieve the same thing. I&rsquo;m not going to attempt to explain when/how to use these concepts in this post, but I&rsquo;ve heard from some of my junior team members that some of these concepts finally &ldquo;clicked&rdquo; in their mind when they see it being used in the example above. Hopefully it also does something for you to get a better sense of how to better use Elixir&rsquo;s language features to write a more succinct, more declarative idiomatic code.</p></article></div></body></html>